#!/bin/bash


set -Eeuo pipefail
trap 'echo "Error on line $LINENO. Exiting."; exit 1' ERR
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
ORIGINAL_USER=${SUDO_USER:-$USER}
ORIGINAL_UID=$(id -u "$ORIGINAL_USER")
USER_HOME=$(getent passwd "$ORIGINAL_USER" | cut -d: -f6)
APP_DIR="$SCRIPT_DIR"
BRANCH="main"               

# Relaunch as root if not already
if [[ $EUID -ne 0 ]]; then
    echo "Cowboy Update requires sudo."
    exec sudo "$0" "$@"
fi

# Colors (only if output is a TTY)
if [ -t 1 ]; then
    RED="\e[31m"
    GREEN="\e[32m"
    YELLOW="\e[33m"
    BLUE="\e[34m"
    MAGENTA="\e[35m"
    CYAN="\e[36m"
    BOLD="\e[1m"
    DIM="\e[2m"
    RESET="\e[0m"
else
    RED=""; GREEN=""; YELLOW=""; BLUE=""
    MAGENTA=""; CYAN=""; BOLD=""; DIM=""; RESET=""
fi

notify_user() {
    local title="$1"
    local message="$2"
    local icon="${3:-dialog-information}"
    sudo -u "$ORIGINAL_USER" \
        DBUS_SESSION_BUS_ADDRESS="unix:path=/run/user/$ORIGINAL_UID/bus" \
        notify-send -a "Cowboy Update" -i "$icon" "$title" "$message"
}

echo -e "${CYAN}
╔═══════════════════════════════════╗
║                                   ║
║                                   ║
║      COWBOY_UPDATE SCRIPT         ║
║                                   ║
║                                   ║
╔═══════════════════════════════════╝⠀⠀ ⠀⠀
${RESET}"
read -p "Press Enter to begin..."

self_update() {
    # Make sure git exists
    if ! command -v git &>/dev/null; then
        echo "git is required for self-update, skipping..."
        return
    fi

    # Get the actual directory where this script lives
    SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
    
    if [ ! -d "$SCRIPT_DIR/.git" ]; then
        echo "Error: $SCRIPT_DIR is not a git repository!"
        return
    fi

    cd "$SCRIPT_DIR" || return

    # Fetch latest changes
    git fetch origin "$BRANCH" --quiet

    # Detect if HEAD is detached
    DETACHED=$(git symbolic-ref --quiet --short HEAD || echo "DETACHED")

    if [ "$DETACHED" = "DETACHED" ]; then
        echo -e "\e[33mDetached HEAD detected. Resetting to $BRANCH\e[0m"
        git checkout -B "$BRANCH" "origin/$BRANCH"
    else
        # Make sure local branch exists and tracks remote
        git checkout "$BRANCH" >/dev/null 2>&1 || git checkout -b "$BRANCH" "origin/$BRANCH"
    fi

    LOCAL_HASH=$(git rev-parse HEAD)
    REMOTE_HASH=$(git rev-parse origin/"$BRANCH")

    if [ "$LOCAL_HASH" != "$REMOTE_HASH" ]; then
        echo -e "\e[33mA new update for Cowboy Update is available!\e[0m"
        read -rp "Do you want to update now? (y/N): " choice
        case "$choice" in
            y|Y)
                echo -e "\e[32mUpdating Cowboy Update...\e[0m"

                # Stash local changes if any
                STASHED=false
                if ! git diff-index --quiet HEAD --; then
                    git stash push -q -u -m "cowboy-update-autostash-$(date +%F_%H%M%S)"
                    STASHED=true
                fi

                # Force reset to remote branch
                git reset --hard "origin/$BRANCH"
                git clean -fd

                # Reapply stash if needed
                if [ "$STASHED" = true ]; then
                    git stash pop -q
                fi

                echo -e "\e[32mUpdate pulled successfully! New commit: $(git rev-parse HEAD)\e[0m"

                # Update desktop file if it exists
                if [ -f "$APP_DIR/cowboy_update.desktop" ]; then
                    cp "$APP_DIR/cowboy_update.desktop" "$HOME/.local/share/applications/" 2>/dev/null
                fi

                echo -e "\e[32mUpdate complete! Relaunching...\e[0m"
                exec "$0" "$@"  # restart script
                ;;
            *)
                echo -e "${YELLOW}Update skipped.${RESET}"
                ;;
        esac
    else
        echo -e "${GREEN}Cowboy-update is on latest version.${RESET}"
    fi
}



self_update
warn_large_update() {

    # Get list of packages that would be upgraded
    UPDATE_LIST=$(checkupdates 2>/dev/null)
    NUM_UPDATES=$(echo "$UPDATE_LIST" | wc -l)

    if [ "$NUM_UPDATES" -gt 20 ]; then
        echo -e "${YELLOW}⚠️  There are $NUM_UPDATES packages to update.${RESET}"
        echo -e "${YELLOW}This is a large update and may take a while.${RESET}"
        read -p "Do you want to proceed with the update? (y/n): " proceed
        if [[ ! "$proceed" =~ ^[Yy]$ ]]; then
            echo -e "${GREEN}Update canceled.${RESET}"
            exit 0
        fi
    fi
}


# Track stats
PACKAGES_UPDATED=0
ORPHANS_REMOVED=0
CACHE_CLEANED="0 MB"

print_failure_art() {
cat <<'EOF'
⠀⠀⢀⣴⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣯
⠀⠀⢩⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠘⢿⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⣿⠟⠋⠀
⠀⢴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠛⣿⣿⡿⠿⣿⡿⢻⠟⣿⡟⠀⠈⠀⠙⠷⡝⠿⣝⠛⠛⠉⠛⠻⠿⠟⢿⣿⡿⠄⠀⠀⠀⠀⠀⠀
⠶⠿⢿⣿⣿⣿⣿⣿⣿⣿⢻⡿⠁⠀⠀⠉⠀⠀⠀⠀⠀⠀⡼⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠛⠿⣿⣿⣿⡿⢿⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠐⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⢚⣽⡟⠛⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠈⠍⠀⠀⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣦⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢷⡄⠀⠀⢴⣄⠘⠃⠀⠀⠀⠻⣿⡋⢀⢀⢀⡀⠀⠀⠀⠀⣿⣤⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⠀⢠⣶⣶⣦⣤⣴⣚⣽⡏⣿⣿⣿⣿⣶⣭⣤⣄⠀⠀⣼⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⣿⣿⣿⡜⡿⣿⣿⣿⢸⣿⣿⣿⣿⣿⣿⣿⡆⠀⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⣶⣦⣝⣿⣿⡏⣼⣿⣿⣿⠘⣿⣿⣿⣿⣿⣿⣿⡇⠀⢹⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⠿⡛⠁⣿⣿⣿⠈⠻⢙⢿⣿⣿⡟⠀⣿⣿⣿⣿⣿⣿⣿⠁⣿⡌⠃⠀⠀⢀⣿⣦⣀⠀⢀⣴⣿⣷⣦⡀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⣵⣿⣷⣼⣿⣿⡟⠀⢠⣿⣷⠙⣿⣧⡀⢿⣿⣿⣿⣿⣿⣿⡸⣿⠀⠀⠀⠀⣾⣿⣿⣿⣷⣝⢿⣿⣿⣿⣿
⠀⠀⢀⣀⣠⣤⣴⣶⠶⢟⣼⣿⠿⠿⠿⠟⠋⠀⠀⢹⡿⠃⢠⣿⣿⣿⣿⣿⣿⠿⢟⣫⣿⣇⠏⠀⠀⠀⣼⣿⣿⣿⣿⣿⣿⣷⣮⡻⣿⣿
⣾⣿⣿⣿⣿⣿⣿⣆⢸⣿⣿⣿⣿⣿⣿⣶⣶⣶⣤⣘⡀⠀⠈⠻⣿⣿⠿⠿⠾⠿⢛⣿⣿⠃⠀⠀⠀⢰⣿⣿⣿⣿⣿⣿⣿⣿⠟⢠⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⡎⣿⣿⡿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣶⣤⡘⢿⣷⣶⣶⣶⣿⣿⡏⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⡿⠛⠁⣠⣾⣿⣿
⣿⣿⣿⣿⣿⣿⡻⠟⢸⣿⣿⣿⣿⣶⣮⣭⣟⣛⣛⠿⣿⣿⠏⠉⠙⠷⣝⣿⣿⣿⣿⠟⠀⠀⠀⠀⣠⣿⣿⣿⣿⠟⠉⠀⣠⣾⣿⣿⣿⣿
⠉⠉⠛⠻⠿⣿⣿⣷⡄⠙⠿⠿⢿⣿⣿⣿⣿⣿⠛⠋⠀⠀⠀⠀⠀⠀⠀⠈⠛⠉⠀⠀⠀⠀⠀⣰⣿⡿⠟⠋⠁⠀⣠⣾⣿⣿⣿⣿⣿⣿
⠿⠷⢶⠦⠀⠈⠛⣽⡇⠀⠀⠀⣀⣀⣈⡉⠙⠛⠀⠀⠀⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⢠⣾⠟⠁⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⠟
⣴⣾⣿⠿⢂⢰⢷⣿⡄⠀⠀⠀⠀⠙⠻⠿⣿⣶⠶⠄⠀⠀⠀⣴⣾⣷⠀⠀⠀⠀⠀⠀⢰⣿⡟⠀⠀⠀⠀⡀⠀⢸⣿⣿⣿⣿⣿⡿⠋⠀
⠟⠉⣠⣾⡟⣾⣼⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡄⠀⡄⠀⠀⣽⣿⣦⡀⠀⠀⠀⢀⣿⣿⡇⠀⠀⠀⢀⣿⡀⠈⣿⣿⣿⣿⡟⠁⠀⠀
⢠⣾⣿⣿⢣⣿⣿⡟⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⢻⡀⠈⠛⠿⣯⡀⠀⠀⢀⣾⡿⠿⠃⣠⡆⠀⠀⣿⣧⠀⢹⣿⣿⣿⣷⣄⠀⠀
⣿⣿⣿⣿⣸⣿⢹⣷⡙⣿⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⣿⣦⡀⠀⢠⡉⠃⢠⢋⣤⠀⢠⣾⣿⡇⠀⢀⠘⣿⡄⠈⣿⣿⣿⣿⣿⣷⣤
⣿⣿⣿⣿⣿⣿⡎⢿⣿⡌⠻⣷⡄⠀⠀⠀⠀⠀⠀⠀⢰⢹⣿⣿⣿⣦⡀⠻⣤⣦⣾⢃⣴⣿⣿⣿⠃⠀⢸⣆⠘⠇⠀⢹⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⡈⠛⠋⠀⠈⠙⠆⠀⠀⠀⠀⠀⠀⠁⠀⣿⣿⣿⣿⣿⡄⣿⣿⣿⣿⣿⣿⣿⠃⣼⠁⠀⣿⣿⣶⡄⠘⣿⣿⣿⣿⣿⣿
EOF
}

# Check Arch news
echo
echo -e "${BOLD}Checking recent Arch news...${RESET}"
curl -s https://archlinux.org/feeds/news/ | grep -oP '(?<=<title>).*?(?=</title>)' | head -n 5 | tail -n 4
echo ""
read -p "Press Enter to continue with updates..."
echo

# Track if kernel was updated during this run
KERNEL_UPDATED=false

warn_large_update

# Update official repos
echo
echo "======================================="
echo -e "${GREEN}Updating Official Repository...${RESET}"
echo "======================================="
# Capture pacman output to check if kernel was updated
PACMAN_LOG=$(mktemp)

script -q -c "pacman -Syu" "$PACMAN_LOG"

PACMAN_OUTPUT=$(cat "$PACMAN_LOG")
rm "$PACMAN_LOG"

# Count packages updated
PACKAGES_UPDATED=$(echo "$PACMAN_OUTPUT" | grep -c "upgrading")

# Check for any kernel package update (CachyOS or standard Arch)
if echo "$PACMAN_OUTPUT" | grep -qE 'linux-cachyos|^linux |linux-lts|linux-zen|linux-hardened'; then
    KERNEL_UPDATED=true
fi

if echo "$PACMAN_OUTPUT" | tail -5 | grep -qi "error\|failed"; then
        echo -e "${YELLOW}pacman failed!${RESET}"
        print_failure_art
        notify_user "Update Failed" "pacman failed" cowboy-icon
fi

echo
echo "======================================="
echo -e "${GREEN}Updating AUR Packages...${RESET}"
echo "======================================="
if ! paru -Sua; then
    echo -e "${YELLOW}paru failed!${RESET}"
    print_failure_art
    notify_user "Update Failed" "paru failed" cowboy-icon
fi

echo
echo "======================================="
echo -e "${GREEN}Updating Flatpaks...${RESET}"
echo "======================================="
if ! flatpak update; then
    echo -e "${YELLOW}flatpak failed!${RESET}"
    print_failure_art
    notify_user "Update Failed" "flatpak failed" cowboy-icon
fi

echo
echo "======================================="
echo -e "${YELLOW}Cleaning...${RESET}"
echo "======================================="

# Check for orphaned packages
echo
echo "Checking for orphaned packages..."
echo
ORPHANS=$(pacman -Qtdq 2>/dev/null)
if [ -n "$ORPHANS" ]; then
    ORPHANS_REMOVED=$(echo "$ORPHANS" | wc -l)
    echo "Found orphaned packages:"
    echo "$ORPHANS"
    read -p "Remove them? (y/n): " choice
    if [[ $choice == "y" || $choice == "Y" ]]; then
        pacman -Rns $ORPHANS --noconfirm
    else
        ORPHANS_REMOVED=0
    fi
else
    echo "No orphaned packages found."
    echo
    ORPHANS_REMOVED=0
fi

# Clean package cache (keep last 2 versions)
echo "Cleaning package cache..."
echo
if command -v paccache &> /dev/null; then

    CACHE_BEFORE=$(du -sm /var/cache/pacman/pkg/ | awk '{print $1}')
    
    paccache -rk2 > /dev/null 2>&1
    paccache -ruk0 > /dev/null 2>&1
    
    CACHE_AFTER=$(du -sm /var/cache/pacman/pkg/ | awk '{print $1}')
    CACHE_CLEANED="$((CACHE_BEFORE - CACHE_AFTER)) MB"
else
    echo "paccache not found (install pacman-contrib)"
    CACHE_CLEANED="0 MB"
fi

# Clean Flatpak cache
if command -v flatpak &> /dev/null; then
    echo "Cleaning Flatpak cache..."
    echo
    flatpak uninstall --unused -y > /dev/null 2>&1
fi

# Check for .pacnew and .pacsave files
echo "Checking for .pacnew/.pacsave files..."
echo
PACNEW_FILES=$(find /etc -name "*.pacnew" 2>/dev/null)
PACSAVE_FILES=$(find /etc -name "*.pacsave" 2>/dev/null)

if [ -n "$PACNEW_FILES" ]; then
    echo "Found .pacnew files:"
    echo "$PACNEW_FILES"
fi

if [ -n "$PACSAVE_FILES" ]; then
    echo "Found .pacsave files:"
    echo "$PACSAVE_FILES"
fi

# List services using old libraries
if command -v needrestart &> /dev/null; then
    echo "Checking for services needing restart..."
    needrestart -l
fi


# Show disk space saved
BEFORE=$(df / | tail -1 | awk '{print $4}')
# ... do updates and cleaning ...
AFTER=$(df / | tail -1 | awk '{print $4}')
SAVED=$((AFTER - BEFORE))
echo
echo "Freed up: $((SAVED / 1024)) MB"

# Check if reboot needed
if [ "$KERNEL_UPDATED" = true ]; then
    echo
    echo "⚠️  REBOOT REQUIRED - Kernel was updated! ⚠️"
    echo
    notify_user "Kernel was updated during this session""Reboot Required" cowboy-icon
fi

echo "+------------------------------------+"
echo -e "|${GREEN} SUCCESS! YOU CARRIED THAT WEIGHT!${RESET}  |"
echo "+------------------------------------+"
    echo "⣿⣿⣿⣿⣿⡿⠛⠋⠙⠉⠋⠛⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠿⠿⠿⢿⣿⣿⣿⣿
⣿⣿⣿⣿⣥⣴⣶⣿⣿⣿⣿⣷⣦⡈⠙⣿⣿⣿⣿⣿⣿⣿⣿⡿⠛⣁⣤⣤⣶⣶⣤⣤⣈⣻⣿⣿
⣿⣿⣿⣿⡿⠿⠛⠛⠻⠿⣿⣿⣿⣿⣧⣈⣿⣿⣿⣿⣿⣿⠏⣡⣾⣿⣿⣿⣿⡿⠿⢿⣿⣿⣿⣿
⣿⣿⣿⡏⠀⡀⠂⠄⡁⠐⢘⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠉⠀⡀⠄⠠⠀⠙⣿⣿
⣿⡿⢿⣷⣦⣤⣥⣴⣤⣵⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣤⣁⣀⣂⣁⣬⣴⡿⢿
⣿⠀⣦⣉⠛⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠋⣡⣴⠈
⣧⠀⣿⣿⢰⣦⣬⣉⠛⠿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠟⠋⣉⣤⣶⢐⣿⣿⠀
⣿⠀⣿⡿⢸⣿⣿⣿⣿⠀⣤⣤⣍⣉⣙⠙⠛⠛⠛⠛⠛⠉⣉⣉⣥⣤⣤⠀⣿⣿⣿⣿⢸⣿⡟⢠
⣿⡄⢻⡇⢸⣿⣿⣿⣿⠀⣿⣿⣿⣿⣿⠀⣿⣿⣿⣿⡿⠀⣿⣿⣿⣿⡇⠠⣿⣿⣿⡿⢸⣿⠇⣼
⣿⣷⡈⠇⢸⣿⣿⣿⣿⠀⣿⣿⣿⣿⣿⠀⣿⣿⣿⣿⡇⢈⣿⣿⣿⣿⡇⢸⣿⣿⣿⡇⢸⡟⢠⣿
⣿⣿⣷⡀⢸⣿⣿⣿⣿⠀⣿⣿⣿⣿⣿⠀⣿⣿⣿⣿⡇⢸⣿⣿⣿⣿⡇⢸⣿⣿⣿⡇⠘⢠⣿⣿
⣿⣿⣿⣷⣌⠻⣿⣿⣿⠀⣿⣿⣿⣿⣿⠀⣿⣿⣿⣿⡇⢸⣿⣿⣿⣿⡇⢸⣿⣿⡿⠃⣰⣿⣿⣿
⣿⣿⣿⣿⣿⣧⡈⠻⡏⠠⣿⣿⣿⣿⡏⠐⣿⣿⣿⣿⡇⢸⣿⣿⣿⣿⡇⢸⡿⠛⣡⣾⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣷⣄⡐⠻⢿⣿⣿⡇⢨⣿⣿⣿⣿⡇⢸⣿⣿⣿⡿⠃⣈⣤⣾⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣦⣬⣉⣃⠘⠛⠛⠛⠛⠃⠘⣛⣉⣥⣴⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿"

#Summary
echo "+------------------------------------+"
echo "|         UPDATE SUMMARY             |"
echo "+------------------------------------+"
printf "| %-34s |\n" "Packages updated: $PACKAGES_UPDATED"
#printf "| %-34s |\n" "Space Saved: $((SAVED / 1024)) MB"
printf "| %-34s |\n" "Orphans removed: $ORPHANS_REMOVED"
printf "| %-34s |\n" "Cache cleaned: $CACHE_CLEANED"
printf "| %-34s |\n" "Kernel updated: $([ "$KERNEL_UPDATED" = true ] && echo "YES" || echo "NO")"
echo "+------------------------------------+"

notify_user "System Updated" "Yeehaw"

read -p "Press Enter to close, space cowboy..."
